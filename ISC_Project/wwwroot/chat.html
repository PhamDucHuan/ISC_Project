<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giao diện Hỏi Đáp Lớp Học với Chatbot AI</title>
    <style>
        /* --- Cài đặt chung --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7f8fa;
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Bố cục chính --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            background-color: #fff;
        }

        /* --- 1. Cột Sidebar bên trái --- */
        .sidebar {
            width: 70px;
            background-color: #ffffff;
            border-right: 1px solid #eef0f3;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            flex-shrink: 0;
        }

            .sidebar .logo {
                width: 40px;
                height: 40px;
                background-color: #ff6f00;
                border-radius: 12px;
                margin-bottom: 30px;
            }

            .sidebar nav ul {
                list-style: none;
                width: 100%;
            }

            .sidebar nav li {
                display: flex;
                justify-content: center;
                margin-bottom: 10px;
            }

            .sidebar nav a {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 45px;
                height: 45px;
                color: #a0a9b9;
                text-decoration: none;
                border-radius: 12px;
                font-size: 22px;
                transition: all 0.3s ease;
            }

                .sidebar nav a:hover {
                    background-color: #f7f8fa;
                    color: #ff6f00;
                }

                .sidebar nav a.active {
                    background-color: #ff6f00;
                    color: #ffffff;
                }

        /* --- 2. Cột danh sách câu hỏi (giữa) --- */
        .question-list-panel {
            width: 380px;
            border-right: 1px solid #eef0f3;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .question-list-header {
            padding: 24px;
            border-bottom: 1px solid #eef0f3;
        }

            .question-list-header h2 {
                font-size: 24px;
                font-weight: 600;
                margin-bottom: 15px;
            }

        .tabs {
            display: flex;
            gap: 20px;
        }

            .tabs button {
                background: none;
                border: none;
                font-family: 'Segoe UI', sans-serif;
                font-size: 14px;
                padding: 8px 0;
                cursor: pointer;
                color: #858d9a;
                font-weight: 600;
                border-bottom: 2px solid transparent;
            }

                .tabs button.active, .tabs button:hover {
                    color: #000000;
                    border-bottom-color: #ff6f00;
                }

        .search-bar {
            padding: 20px;
        }

            .search-bar input {
                width: 100%;
                padding: 12px 15px;
                border-radius: 8px;
                border: 1px solid #eef0f3;
                background-color: #f7f8fa;
                font-size: 14px;
            }

        .conversation-list {
            list-style: none;
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 10px;
        }

        .conversation-item {
            display: flex;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

            .conversation-item.active, .conversation-item:hover {
                background-color: #f7f8fa;
            }

            .conversation-item img {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                margin-right: 12px;
                object-fit: cover;
            }

        .conversation-content {
            flex-grow: 1;
        }

            .conversation-content .name {
                font-weight: 600;
                font-size: 15px;
            }

            .conversation-content .message-preview {
                font-size: 14px;
                color: #666;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 200px;
            }

        .conversation-info {
            text-align: right;
            font-size: 12px;
            color: #a0a9b9;
        }

        /* --- 3. Khung Chat chính (bên phải) --- */
        .chat-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff; /* Nền trắng cho panel chat */
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: #ffffff;
            border-bottom: 1px solid #eef0f3;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            flex-direction: column;
        }

        .breadcrumbs {
            margin-bottom: 5px;
        }

            .breadcrumbs a {
                text-decoration: none;
                color: #666;
                font-size: 14px;
            }

                .breadcrumbs a.current {
                    color: #000;
                    font-weight: 600;
                }

        .chat-status {
            font-size: 12px;
            display: flex;
            align-items: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
        }

            .user-profile img {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                margin-right: 10px;
            }

            .user-profile .user-name {
                font-weight: 600;
                margin-right: 15px;
            }

            .user-profile .logout-link {
                font-size: 14px;
                color: #ff6f00;
                text-decoration: none;
                font-weight: 600;
            }

        /* --- CSS CHO IFRAME VÀ LỖI TỪ CODE GỐC --- */
        .chat-body {
            flex-grow: 1;
            position: relative;
        }

        .chat-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .error-message {
            text-align: center;
            padding: 50px 20px;
            color: #666;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

            .error-message h2 {
                color: #f44336;
                margin-bottom: 20px;
            }

        .retry-button {
            background: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

            .retry-button:hover {
                background: #1976D2;
            }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-online {
            background-color: #4CAF50;
        }

        .status-offline {
            background-color: #f44336;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="app-container">
        <aside class="sidebar">
            <div class="logo"></div>
            <nav>
                <ul>
                    <li><a href="#" title="Bảng điều khiển"><i class="fa-solid fa-grip"></i></a></li>
                    <li><a href="#" class="active" title="Hỏi đáp"><i class="fa-regular fa-comments"></i></a></li>
                    <li><a href="#" title="Tài liệu"><i class="fa-regular fa-folder-open"></i></a></li>
                    <li><a href="#" title="Thông báo"><i class="fa-regular fa-bell"></i></a></li>
                    <li><a href="#" title="Cài đặt"><i class="fa-solid fa-gear"></i></a></li>
                </ul>
            </nav>
        </aside>

        <aside class="question-list-panel">
            <header class="question-list-header">
                <h2>Hỏi đáp Q & A</h2>
                <div class="tabs">
                    <button class="active">Tất cả câu hỏi</button>
                    <button>Đã trả lời</button>
                    <button>Gần đây nhất</button>
                </div>
            </header>
            <div class="search-bar">
                <input type="text" placeholder="Tìm kiếm câu hỏi hoặc học viên">
            </div>
            <ul class="conversation-list">
                <li class="conversation-item active">
                    <img src="https://i.pravatar.cc/40?u=chatbot" alt="Avatar">
                    <div class="conversation-content">
                        <div class="name">AI Chat Assistant</div>
                        <div class="message-preview">Đang hoạt động...</div>
                    </div>
                </li>
                <li class="conversation-item">
                    <img src="https://i.pravatar.cc/40?u=ngocngoan" alt="Avatar">
                    <div class="conversation-content">
                        <div class="name">Nguyễn Ngọc Ngoan</div>
                        <div class="message-preview">Alo alo 1234 nghe hong???</div>
                    </div>
                </li>
            </ul>
        </aside>

        <main class="chat-panel">
            <header class="chat-header">
                <div class="header-left">
                    <div class="breadcrumbs">
                        <a href="#" class="current">AI Chat Assistant</a>
                    </div>
                    <div class="chat-status">
                        <span id="status-indicator" class="status-indicator status-offline"></span>
                        <span id="status-text">Connecting...</span>
                    </div>
                </div>
                <div class="user-profile">
                    <img src="https://i.pravatar.cc/40?u=hienmai_profile" alt="User Avatar">
                    <span class="user-name">Hiền Mai</span>
                    <a href="#" class="logout-link">Đăng xuất</a>
                </div>
            </header>

            <div class="chat-body">
                <iframe id="chat-iframe"
                        class="chat-iframe"
                        src="about:blank"
                        onload="handleIframeLoad()"
                        onerror="handleIframeError()">
                </iframe>

                <div id="error-content" class="error-message" style="display: none;">
                    <h2>🚫 Không thể kết nối đến dịch vụ Chat</h2>
                    <p>Chatbot AI hiện không hoạt động. Vui lòng kiểm tra:</p>
                    <ul style="text-align: left; display: inline-block; margin: 20px 0;">
                        <li>Dịch vụ Chat đã được cài đặt chưa?</li>
                        <li>Có đang chạy trên: https://dev-chatbot-hono.vercel.app/ không?</li>
                        <li>Tường lửa có đang chặn kết nối không?</li>
                    </ul>
                    <button class="retry-button" onclick="retryConnection()">Thử lại</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let connectionAttempts = 0;
        const maxAttempts = 3;

        function updateStatus(isOnline, message) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');

            if (isOnline) {
                indicator.className = 'status-indicator status-online';
                text.textContent = message || 'Chat AI đã kết nối';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = message || 'Mất kết nối với Chat AI';
            }
        }

        function showError() {
            document.getElementById('chat-iframe').style.display = 'none';
            document.getElementById('error-content').style.display = 'block';
            updateStatus(false, 'Không thể kết nối Chat AI');
        }

        function hideError() {
            document.getElementById('chat-iframe').style.display = 'block';
            document.getElementById('error-content').style.display = 'none';
        }

        function handleIframeLoad() {
            const iframe = document.getElementById('chat-iframe');
            try {
                // Kiểm tra xem có thể truy cập nội dung iframe không
                if (iframe.src !== 'about:blank' && iframe.contentWindow.location.href !== 'about:blank') {
                    updateStatus(true, 'Chat AI sẵn sàng');
                    hideError();
                    connectionAttempts = 0; // Reset khi thành công
                }
            } catch (e) {
                // Lỗi CORS thường xảy ra ở đây, nhưng nếu iframe load được thì coi như thành công
                console.log('Iframe đã tải nhưng không thể truy cập nội dung (CORS)');
                updateStatus(true, 'Chat AI sẵn sàng');
                hideError();
                connectionAttempts = 0; // Reset khi thành công
            }
        }

        function handleIframeError() {
            console.error('Lỗi khi tải Iframe.');
            if (connectionAttempts >= maxAttempts) {
                showError();
            } else {
                setTimeout(connectToChat, 3000); // Thử lại sau 3s nếu iframe báo lỗi
            }
        }

        function connectToChat() {
            if (connectionAttempts >= maxAttempts) {
                showError();
                return;
            }
            connectionAttempts++;
            updateStatus(false, `Đang kết nối đến Chat AI (lần ${connectionAttempts})...`);
            hideError(); // Ẩn lỗi cũ khi thử lại

            const iframe = document.getElementById('chat-iframe');
            const chatUrl = 'https://dev-chatbot-hono.vercel.app/';

            // Dùng fetch để kiểm tra dịch vụ có sống không trước khi gán src
            fetch(chatUrl, { mode: 'no-cors' }) // no-cors để tránh lỗi CORS khi chỉ ping
                .then(() => {
                    console.log('Dịch vụ có phản hồi. Đang tải iframe...');
                    iframe.src = chatUrl;
                })
                .catch(() => {
                    console.error('Không thể fetch dịch vụ. Thử lại...');
                    if (connectionAttempts < maxAttempts) {
                        setTimeout(connectToChat, 3000);
                    } else {
                        showError();
                    }
                });
        }

        function retryConnection() {
            connectionAttempts = 0;
            connectToChat();
        }

        // Bắt đầu kết nối khi tải trang
        window.onload = function () {
            connectToChat();
        };
    </script>
</body>
</html>